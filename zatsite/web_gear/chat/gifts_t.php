<?php

header("Content-Type: text/json");


 /*
 * Creator - Austin
 * Made for ixat.io source
 * Gifts or 20044
 */
//die('{"timestamp":1446217091,"1336517712":{"id":98440,"n":"Fino","g":"xat","s":"42","f":4},"1336519185":{"id":396333305,"n":"Tino","g":"Help","s":"42","f":4},"1336519343":{"id":134396192,"n":"Spawn","g":"eegg3","m":"You owe me grandchildren.","s":"(D) Pay up.","f":1},"1336519491":{"id":134396192,"n":"Spawn","g":"eegg3","m":"You getting mad at the gifts yet? If not, I\'ll keep sending","s":"Gift time","f":1},"1336649322":{"id":3253030,"n":"Testidchat","g":"Help","m":"Sir please pc me one minute :$","s":"42","f":5},"1336934377":{"id":1000000,"n":"COLD","g":"eegg5","m":"Hi","s":"42 :)","f":1},"1337123563":{"id":169777792,"n":"Leet","g":"Rocket1","m":"Have a nice day :)","s":"Hi","f":1},"1337123674":{"id":145922524,"n":"K3vin","g":"Rocket1","m":"Go to school :D","s":"K3vin","f":1},"1337123753":{"id":1717170,"n":"Aces","g":"Rocket1","m":"I love xat <3","s":"42","f":1},"1337373145":{"id":383828110,"n":"XAjuda","g":"eegg3","m":"42 think what I said and please reply :( Thanks :D:D","s":"Hey","f":1},"1337373534":{"id":383828110,"n":"XAjuda","g":"Owner","m":"I Love you black pawn and black pawn gift congrats for xat.com","s":"42","f":1},"1337373808":{"id":145922524,"n":"K3vin","g":"Rocket1","m":"You\'re sexy love kevin","s":"K3vin","f":1},"1337375824":{"id":383828110,"n":"XAjuda","g":"eegg3","s":"Again","f":0},"1337375902":{"id":383828110,"n":"XAjuda","g":"Member","m":"Pc me emo S2 (XD)","s":"Pc me","f":1},"1337381407":{"id":202802300,"n":"ToadsNewAccount","g":"xat","m":"Thanks for the best place ever, xat! :D","s":"You Rock :D","f":5},"1337460297":{"id":145922524,"n":"K3vin","g":"eegg3","m":"Bye 42 :$","s":"K3vin","f":1},"1337896327":{"id":134396192,"n":"Spawn","g":"eegg3","s":"You owe me","f":0},"1340713645":{"id":1015051,"n":"Epico","g":"Rocket1","m":"Have a good summer to you and family : )","s":"","f":1},"1340714009":{"id":371280124,"n":"xEno42x","g":"eegg1","s":"Hi 42","f":0},"1342007943":{"id":10101010,"n":"Life","g":"Owner","s":"Your loved :$","f":0},"1344123430":{"id":371334831,"n":"iHeats","g":"eegg2","m":"hi","s":"hi","f":1},"1344123466":{"id":371334831,"n":"iHeats","g":"eegg2","m":":$ again","s":"hi","f":1},"1344123512":{"id":272647429,"n":"fantage","g":"Football2","m":"its-nike","s":"heyyyy","f":5},"1344124255":{"id":1001007,"n":"kates","g":"Mp3","m":"42, Thankyou for the new power (Alien) Even though I dont know why you gave it to me, thankyou! -Katie","s":"Thankyou 42 !","f":5},"1344124328":{"id":53378511,"n":"Spawn","g":"eegg4","m":"Did you know that I\'m bored and I\'m sending you a gift?","s":"Did you know?","f":1},"1346283034":{"id":1020305,"n":"Test","g":"eegg4","s":"hi 42","f":0},"1346366617":{"id":173779645,"n":"itziotterr","g":"easter6","m":"Thanks for creating xat (awe)","s":"","f":5},"1346366762":{"id":193663060,"n":"Rapt0r","g":"Rocket1","m":"Hey, how are you doe","s":"Hi 42","f":1},"1346535832":{"id":97899964,"n":"IzzyPop","g":"D","m":"Thank you for making xat.","s":"hi","f":1},"1353692741":{"id":400689299,"n":"K3vin","g":"Dog","m":"Hey Hun I think it\'s time for me to get a gift now (;","s":"Kevin","f":1},"1353692786":{"id":379269733,"n":"Kirito","g":"Rocket1","m":"Sylver Pawn :c","s":"Sylver","f":1},"1355096359":{"id":372341669,"n":"xSuperHero","g":"PenguinIce","m":"HAPPY CHRISTMAS :D","s":"","f":1},"1355096439":{"id":320821221,"n":"Shineba","g":"Decoration","m":"vai tomar no c\u00fa e me da uns powers seu fdp","s":"42","f":5},"1355241132":{"id":425436616,"n":"OGURREIRO157","g":"GingerbreadMan","m":"merry christmas [4 2] and parabens by xat","s":"","f":1},"1356532494":{"id":90206013,"n":"Sony","g":"GingerbreadHouse","m":"Happy Holiday you and your family (hug)","s":"42 :)","f":5},"1361033311":{"id":169900002,"n":"Beet","g":"PlushCat","m":"iloveu <3","s":"","f":5},"1363473416":{"id":278415483,"n":"iChris","g":"Rocket1","m":"I love yew<3 Gurly we should hang soon! TEXT ME!","s":"42","f":1},"1364483575":{"id":803210597,"n":"Webster100","g":"Owner","m":"HEY 42!!!! U ROCK!!!!! when did u make xat pc me and tell meeeee","s":"42 U ROCK","f":1},"1364487324":{"id":420881389,"n":"magicbetis","g":"Rocket1","s":"magicbetis","f":0},"1364491746":{"id":1000069,"n":"News","g":"PurplePawn","s":"Hi 42","f":4},"1367069830":{"id":220000913,"n":"Ghost","g":"xat","s":"Test","f":4},"1367070347":{"id":220000913,"n":"Ghost","g":"Rocket1","s":"Proof","f":0},"1367075751":{"id":365600743,"n":"hoslord1234","g":"Chocs1","m":"Happy Birthday!","s":"Happy Birthday!","f":5},"1370626027":{"id":1020305,"n":"coolestidever","g":"Rocket1","m":"Hello, I\'m Mace, nice to meet you.","s":"Hi 42","f":1},"1370775555":{"id":8337000,"n":"Beet","g":"Dog","m":"Have a nice holidays :D","s":"From Beet","f":1},"1376409798":{"id":80330110,"n":"xneww","g":"Owner","s":"hi","f":0},"1381486039":{"id":1090109,"n":"Chip","g":"IceCream","m":"Hi.","s":"Hello!","f":5},"1381783532":{"id":299166133,"n":"Cris","g":"Dog","m":"UGLY USER 42 :$ <3","s":"from BEET","f":1},"1387897576":{"id":1000104343,"n":"JX4TT","g":"WinterHat","s":"","f":4},"1387898080":{"id":86355389,"n":"Sear","g":"TreeGinger","s":"Happy Christmas","f":4},"1387930674":{"id":172834967,"n":"Apex","g":"WinterHat","m":"Have a fantastic day! :D","s":"Merry Christmas!","f":5},"1388328226":{"id":8000000,"n":"Beet","g":"SantaClaus","s":"Hi","f":4},"1399575123":{"id":1185541978,"n":"iDevil666","g":"Blank","s":"Hi There","f":3},"1399575828":{"id":10300000,"n":"Luc4","g":"Blank","s":"","f":3},"1399726593":{"id":360000142,"n":"KingOfKing9gag","g":"Blank","s":"Check my ticket all my ids are held (xd)","f":2},"1400927816":{"id":1000030,"n":"Gods","g":"Blank","s":"42","f":2},"1401270226":{"id":1434433175,"n":"Awoken","g":"Blank","s":"sup sexy","f":3},"1418994712":{"id":217060577,"n":"BabyGurl","g":"Blank","s":"Merry Christmas","f":7},"1420971694":{"id":388275558,"n":"mino","g":"Blank","s":"hello","f":7},"1420971806":{"id":739328426,"n":"Skeight","g":"Blank","s":"42 ;DD","f":3},"1422650003":{"id":107567776,"n":"Deus","g":"Blank","s":"test","f":3},"1426933065":{"id":1488197963,"n":"yeroghostt","g":"Blank","s":"6 years in xat","f":2},"1427233699":{"id":1482284057,"n":"OsmanliEvladi","g":"Blank","s":"","f":7},"1427234004":{"id":1482284057,"n":"OsmanliEvladi","g":"Blank","s":"","f":7},"1427234598":{"id":1489835499,"n":"iipremio","g":"Blank","s":"Hi 42","f":3},"1427289730":{"id":8888,"n":"Ares","g":"Blank","s":"Ares","f":2},"1427575080":{"id":856767608,"n":"Kueio","g":"Blank","s":"My boy","f":2},"1431183385":{"id":1090109,"n":"Chip","g":"Blank","s":"what is this?","f":2},"1431808182":{"id":444455555,"n":"Aiden","g":"Blank","s":"From Aiden","f":7},"1435608090":{"id":173000000,"n":"Edit","g":"Blank","s":"hello Boss!!","f":3},"1446217091":{"id":1138434737,"n":"IBau","g":"Blank","s":"Xp","f":7}}');
//^that is just for testing
$t = explode(',', $_GET['id']);
$id = intval($t[0]);
$k1b = intval($t[2]);
$del = intval($_REQUEST['del']);
$flags = $_REQUEST['flags'];
$k = intval($_REQUEST['k']);
$old = isset($_REQUEST['old']);
if($id <= 0) { exit("No gifts."); }

require str_replace('\\', '\\\\', "../../_class/") . 'pdo.php';
$pdo = new Database();
if(!$pdo->conn) exit("System problem (1), please try later.");

if($k1b > 0) {
	$user = $pdo->fetch_array("select `k` from `users` where `id`=:uid;", array("uid" => $id));
	if($user[0]['k'] == $k1b)
		$isuser = "indeed it's them good sir";
}
$update = (isset($isuser) && $old && $k) ? true:false;
$gifts = $pdo->fetch_array("select * from `gifts` where ".($update ? "`time`='".$k."' and ":"")."`b`=:reg ". (!isset($isuser) ? "and `f`>0 ":"") ."order by `time` desc".($update? " limit 0,1;":";"), array('reg'=>$id));

if($del) {
	if(!isset($isuser)) exit("Delete failed (1). Try later.");
	$read = $pdo->query('delete from `gifts` where `time`=:time and `b`=:uid;', array('time' => $k, 'uid' => $id));
	exit("deleted");	
}

if(isset($flags)) {
	if(!isset($isuser)) exit("Set failed (1). Try later.");
	$read = $pdo->query('update `gifts` set `f`=:new where `time`=:time and `b`=:uid;', array('new' => intval($flags), 'time' => $k, 'uid' => $id)); //update flag to read
	exit("updated flags");	
}

if($old) {
	if(!isset($isuser)) exit("Set failed (2). Try later.");
	$read = $pdo->query('update `gifts` set `f`=:new where `time`=:time and `b`=:uid;', array('new' => $gifts[0]['f'] &= ~2, 'time' => $k, 'uid' => $id)); //update flag to read
	exit("updated read");	
}
	
if(empty($gifts)) exit("No gifts.");
$json = array('timestamp' => end($gifts)['time']);
foreach($gifts as $gift) {
	$time = $gift['time'];
		
	if($gift['f'] == 0 && !isset($isuser))
		unset($gift['m']);
		
	unset($gift['time'], $gift['b'], $gift['gid']);
	$json[$time] = $gift;
}
exit(json_encode($json));
?>